{% extends 'dashboard/base.html' %}

{% block page_title %}{% if is_edit %}Edit{% else %}Create{% endif %} Event Email Template{% endblock %}

{% block extra_css %}
<style>
    #email-editor-container {
        height: 700px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .action-bar {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .event-badge {
        display: inline-block;
        padding: 6px 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
    }
    
    .variable-pill {
        display: inline-block;
        padding: 4px 12px;
        margin: 4px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 20px;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #90caf9;
    }
    
    .variable-pill:hover {
        background: #1976d2;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .save-status {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
    }
    
    .save-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="post" id="templateForm">
        {% csrf_token %}
        
        <!-- Hidden fields -->
        <input type="hidden" name="template_type" id="template_type" value="{% if template %}{{ template.template_type }}{% else %}custom{% endif %}">
        <input type="hidden" name="body_html" id="body_html">
        <input type="hidden" name="builder_config" id="builder_config">
        <input type="hidden" name="is_active" id="is_active" value="{% if template %}{{ template.is_active }}{% else %}true{% endif %}">
        {% if base_template %}
        <input type="hidden" name="base_template_id" value="{{ base_template.id }}">
        {% endif %}
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'dashboard:event_email_templates' event.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <div>
                    <h3 class="mb-0">
                        <i class="bi bi-envelope-paper"></i> 
                        {% if is_edit %}Edit{% else %}Create{% endif %} Email Template
                    </h3>
                    <span class="event-badge mt-2">{{ event.name }}</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" id="previewBtn">
                    <i class="bi bi-eye"></i> Preview
                </button>
                <button type="button" class="btn btn-outline-secondary" id="advancedBtn">
                    <i class="bi bi-gear"></i> Advanced
                </button>
                <button type="submit" class="btn btn-primary" id="saveBtn">
                    <i class="bi bi-save"></i> Save Template
                </button>
            </div>
        </div>
        
        <!-- Template Information -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="template_name" class="form-label fw-bold">
                                Template Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="template_name" name="name" 
                                   value="{% if template %}{{ template.name }}{% elif base_template %}{{ base_template.name }}{% endif %}" required 
                                   placeholder="e.g., Event Invitation Email">
                            <small class="text-muted">Internal name for easy identification</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="template_subject" class="form-label fw-bold">
                                Email Subject <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="template_subject" name="subject" 
                                   value="{% if template %}{{ template.subject }}{% elif base_template %}{{ base_template.subject }}{% endif %}" required 
                                   placeholder="e.g., You're invited to {{event_name}}">
                            <small class="text-muted">What recipients will see in their inbox</small>
                        </div>
                    </div>
                </div>
                {% if base_template %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> This template is based on: <strong>{{ base_template.name }}</strong>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Merge Tags Helper -->
        <div class="card mb-3 border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-code-square"></i> How to Use Merge Tags (Personalization)</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="mb-2"><strong>What are Merge Tags?</strong></p>
                        <p class="small mb-3">
                            Merge tags are placeholders like {% verbatim %}<code>{{event_name}}</code>{% endverbatim %} that get automatically replaced with real data when sending emails.
                            For example, {% verbatim %}<code>{{participant_name}}</code>{% endverbatim %} becomes "John Doe" for that specific recipient.
                        </p>
                        
                        <p class="mb-2"><strong>How to use them:</strong></p>
                        <ol class="small mb-3">
                            <li><strong>Click</strong> any tag below to copy it to your clipboard</li>
                            <li><strong>In Unlayer editor:</strong> Add a text block</li>
                            <li><strong>Paste</strong> the tag (Ctrl+V) where you want personalized data</li>
                            <li><strong>Example:</strong> Type "Hello {% verbatim %}{{participant_name}}{% endverbatim %}" in your email</li>
                            <li>When sent, it becomes "Hello John Doe" for each recipient</li>
                        </ol>
                        
                        <div class="alert alert-warning alert-sm mb-0">
                            <small>
                                <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> 
                                Keep the double curly braces {% verbatim %}<code>{{ }}</code>{% endverbatim %} exactly as shown. 
                                Don't remove or modify them, or the tag won't work!
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-2"><strong>Quick Example:</strong></p>
                        <div class="bg-light p-3 rounded small">
                            <p class="mb-2"><strong>Your email text:</strong></p>
                            <code class="d-block mb-3">
                                {% verbatim %}Hello {{first_name}},<br><br>
                                Welcome to {{event_name}}!<br>
                                Location: {{event_location}}<br>
                                Your badge: {{badge_id}}{% endverbatim %}
                            </code>
                            
                            <p class="mb-2"><strong>Recipient sees:</strong></p>
                            <div class="bg-white p-2 rounded border">
                                Hello <span class="text-primary">Ahmed</span>,<br><br>
                                Welcome to <span class="text-primary">Tech Conference 2026</span>!<br>
                                Location: <span class="text-primary">Algiers</span><br>
                                Your badge: <span class="text-primary">BADGE-001</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <p class="mb-2"><strong>Available Tags (click to copy):</strong></p>
                <div class="d-flex flex-wrap gap-2">
                    {% for var in template_variables %}
                    <span class="variable-pill" data-var="{{ var }}" title="Click to copy">{{ var }}</span>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <p class="small mb-2"><strong>Tag Reference:</strong></p>
                    <div class="row small">
                        <div class="col-md-6">
                            <ul class="mb-0">
                                {% verbatim %}
                                <li><code>{{event_name}}</code> → Event title</li>
                                <li><code>{{event_location}}</code> → Where the event is</li>
                                <li><code>{{event_start_date}}</code> → When it starts</li>
                                <li><code>{{event_end_date}}</code> → When it ends</li>
                                <li><code>{{participant_name}}</code> → Full name (First Last)</li>
                                <li><code>{{first_name}}</code> → First name only</li>
                                {% endverbatim %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0">
                                {% verbatim %}
                                <li><code>{{last_name}}</code> → Last name only</li>
                                <li><code>{{email}}</code> → Email address</li>
                                <li><code>{{telephone}}</code> → Phone number</li>
                                <li><code>{{etablissement}}</code> → Institution/Organization</li>
                                <li><code>{{badge_id}}</code> → Unique badge ID</li>
                                <li><code>{{qr_code_url}}</code> → QR code image URL</li>
                                {% endverbatim %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Builder Section -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-brush"></i> Design Your Email</h5>
            </div>
            <div class="card-body p-0">
                <div id="email-editor-container"></div>
            </div>
        </div>
    </form>
</div>

<!-- Advanced Settings Modal -->
<div class="modal fade" id="advancedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear"></i> Advanced Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="settingsType" class="form-label">Template Type</label>
                    <select class="form-select" id="settingsType">
                        <option value="invitation" {% if template.template_type == 'invitation' or base_template.template_type == 'invitation' %}selected{% endif %}>Invitation</option>
                        <option value="confirmation" {% if template.template_type == 'confirmation' or base_template.template_type == 'confirmation' %}selected{% endif %}>Confirmation</option>
                        <option value="reminder" {% if template.template_type == 'reminder' or base_template.template_type == 'reminder' %}selected{% endif %}>Reminder</option>
                        <option value="follow_up" {% if template.template_type == 'follow_up' or base_template.template_type == 'follow_up' %}selected{% endif %}>Follow-up</option>
                        <option value="announcement" {% if template.template_type == 'announcement' or base_template.template_type == 'announcement' %}selected{% endif %}>Announcement</option>
                        <option value="registration_confirmation" {% if template.template_type == 'registration_confirmation' or base_template.template_type == 'registration_confirmation' %}selected{% endif %}>Registration Confirmation</option>
                        <option value="custom" {% if template.template_type == 'custom' or base_template.template_type == 'custom' or not template.template_type %}selected{% endif %}>Custom</option>
                    </select>
                    <small class="text-muted">Helps organize and filter templates</small>
                </div>
                
                <div class="mb-0">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="settingsActive" {% if template.is_active or not is_edit %}checked{% endif %}>
                        <label class="form-check-label" for="settingsActive">
                            <strong>Template Active</strong>
                        </label>
                        <small class="d-block text-muted">Only active templates can be used for sending emails</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAdvancedBtn">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Email Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 p-3 bg-light border-bottom">
                    <strong>Subject:</strong> <span id="previewSubject"></span>
                </div>
                <iframe id="previewFrame" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3">Loading Email Editor...</p>
    </div>
</div>

<script src="https://editor.unlayer.com/embed.js"></script>

<script>
let emailEditor;
let settingsModal;
let previewModal;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    advancedModal = new bootstrap.Modal(document.getElementById('advancedModal'));
    previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    // Initialize Unlayer
    emailEditor = unlayer.createEditor({
        id: 'email-editor-container',
        projectId: 1234,
        displayMode: 'email',
        appearance: {
            theme: 'light',
            panels: {
                tools: {
                    dock: 'left'
                }
            }
        },
        features: {
            preview: true,
            imageEditor: true,
            textEditor: {
                tables: true,
                emojis: true
            }
        },
        tools: {
            // Enable countdown timer tool
            timer: {
                enabled: true,
                properties: {
                    countdown: {
                        value: {
                            endTime: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // Default: 7 days from now
                        }
                    }
                }
            },
            // Enable other useful tools
            video: {
                enabled: true
            },
            social: {
                enabled: true
            },
            button: {
                enabled: true
            },
            divider: {
                enabled: true
            },
            html: {
                enabled: true
            },
            image: {
                enabled: true
            },
            text: {
                enabled: true
            },
            heading: {
                enabled: true
            }
        },
        mergeTags: [
            {% for var in template_variables %}
            {
                name: '{{ var|slice:"2:-2" }}',
                value: '{{ var }}',
                sample: '{{ var }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    });

    emailEditor.addEventListener('editor:ready', function() {
        document.getElementById('loadingOverlay').style.display = 'none';
        
        {% if template.builder_config %}
        try {
            emailEditor.loadDesign({{ template.builder_config|safe }});
        } catch (e) {
            console.error('Error loading design:', e);
        }
        {% elif base_template.builder_config %}
        try {
            emailEditor.loadDesign({{ base_template.builder_config|safe }});
        } catch (e) {
            console.error('Error loading design:', e);
        }
        {% endif %}
    });
    
    // Advanced settings
    document.getElementById('advancedBtn').addEventListener('click', () => advancedModal.show());
    document.getElementById('saveAdvancedBtn').addEventListener('click', function() {
        document.getElementById('template_type').value = document.getElementById('settingsType').value;
        document.getElementById('is_active').value = document.getElementById('settingsActive').checked;
        alert('Advanced settings saved!');
        advancedModal.hide();
    });
    
    // Preview
    document.getElementById('previewBtn').addEventListener('click', function() {
        emailEditor.exportHtml(function(data) {
            const previewFrame = document.getElementById('previewFrame');
            const previewSubject = document.getElementById('previewSubject');
            
            // Get subject from visible input field
            const subject = document.getElementById('template_subject').value || 'No subject';
            previewSubject.textContent = subject;
            
            // Load HTML into iframe
            previewFrame.srcdoc = data.html;
            
            // Show modal
            previewModal.show();
        });
    });
    
    // Submit
    document.getElementById('templateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('template_name').value;
        const subject = document.getElementById('template_subject').value;
        
        if (!name || !subject) {
            alert('Please fill in template name and subject');
            document.getElementById('template_name').focus();
            return;
        }
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        
        emailEditor.exportHtml(function(data) {
            document.getElementById('body_html').value = data.html;
            document.getElementById('builder_config').value = JSON.stringify(data.design);
            document.getElementById('templateForm').submit();
        });
    });
    
    // Variable pills
    document.querySelectorAll('.variable-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            navigator.clipboard.writeText(this.dataset.var).then(() => {
                const orig = pill.textContent;
                pill.textContent = '✓ Copied!';
                pill.style.background = '#4caf50';
                pill.style.color = 'white';
                setTimeout(() => {
                    pill.textContent = orig;
                    pill.style.background = '#e3f2fd';
                    pill.style.color = '#1976d2';
                }, 1500);
            });
        });
    });
});

function showSaveStatus(message, type) {
    const status = document.getElementById('saveStatus');
    status.textContent = message;
    status.className = 'save-status ' + type;
    status.style.display = 'block';
    setTimeout(() => status.style.display = 'none', 3000);
}
</script>
{% endblock %}
    
    // Insert variable buttons
    document.querySelectorAll('.insert-var').forEach(button => {
        button.addEventListener('click', function() {
            const varText = this.dataset.var;
            const target = document.activeElement;
            
            if (target === bodyTextarea || target === subjectInput) {
                const start = target.selectionStart;
                const end = target.selectionEnd;
                const text = target.value;
                target.value = text.substring(0, start) + varText + text.substring(end);
                target.focus();
                target.selectionStart = target.selectionEnd = start + varText.length;
            } else {
                bodyTextarea.value += varText;
                bodyTextarea.focus();
            }
        });
    });
    
    // Form submission prevention
    const form = document.getElementById('templateForm');
    form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    });
});
</script>
{% endblock %}
