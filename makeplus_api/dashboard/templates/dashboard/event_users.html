{% extends 'dashboard/base.html' %}

{% block page_title %}{{ event.name }} - Users{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-people"></i> Event Users</h2>
            <p class="text-muted mb-0">{{ event.name }}</p>
        </div>
        <div>
            <a href="{% url 'dashboard:event_detail' event.id %}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Event
            </a>
            <a href="{% url 'dashboard:user_create' %}?event={{ event.id }}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Add User
            </a>
        </div>
    </div>
    
    <!-- Search Bar -->
    <div class="mb-4">
        <input type="text" id="userSearchInput" class="form-control" placeholder="Search by name, email, or username...">
    </div>
    
    <!-- Role Filter Buttons -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" data-role="all">
                <i class="bi bi-people"></i> All ({{ role_counts.all }})
            </button>
            <button type="button" class="btn btn-outline-primary" data-role="organisateur">
                <i class="bi bi-person-badge"></i> Organizers ({{ role_counts.organisateur }})
            </button>
            <button type="button" class="btn btn-outline-primary" data-role="gestionnaire_des_salles">
                <i class="bi bi-door-open"></i> Room Managers ({{ role_counts.gestionnaire_des_salles }})
            </button>
            <button type="button" class="btn btn-outline-primary" data-role="controlleur_des_badges">
                <i class="bi bi-qr-code-scan"></i> Controllers ({{ role_counts.controlleur_des_badges }})
            </button>
            <button type="button" class="btn btn-outline-primary" data-role="exposant">
                <i class="bi bi-shop"></i> Exhibitors ({{ role_counts.exposant }})
            </button>
            <button type="button" class="btn btn-outline-primary" data-role="participant">
                <i class="bi bi-person"></i> Participants ({{ role_counts.participant }})
            </button>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="stat-card">
        {% if user_stats %}
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Badge ID</th>
                        <th>Role</th>
                        <th>Check-in Status</th>
                        {% if role_filter == 'participant' or role_filter == 'all' %}
                        <th>Spent</th>
                        <th>Transactions</th>
                        <th>Accesses</th>
                        <th>Scans</th>
                        {% endif %}
                        <th>Assigned By</th>
                        <th>Assigned Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in user_stats %}
                    <tr data-role="{{ stat.assignment.role }}" data-username="{{ stat.user.username|lower }}" data-email="{{ stat.user.email|lower }}" data-fullname="{{ stat.user.first_name|lower }} {{ stat.user.last_name|lower }}">
                        <td>
                            <strong>{{ stat.user.first_name }} {{ stat.user.last_name }}</strong><br>
                            <small class="text-muted">@{{ stat.user.username }}</small>
                        </td>
                        <td>{{ stat.user.email|default:"No email" }}</td>
                        <td>
                            {% if stat.user.profile.qr_code_data %}
                                <code class="small text-primary">{{ stat.user.profile.qr_code_data.badge_id }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.assignment.role == 'organisateur' %}
                                <span class="badge bg-primary">Organizer</span>
                            {% elif stat.assignment.role == 'gestionnaire_des_salles' %}
                                <span class="badge bg-info">Room Manager</span>
                            {% elif stat.assignment.role == 'controlleur_des_badges' %}
                                <span class="badge bg-warning text-dark">Controller</span>
                            {% elif stat.assignment.role == 'exposant' %}
                                <span class="badge bg-success">Exhibitor</span>
                            {% elif stat.assignment.role == 'participant' %}
                                <span class="badge bg-secondary">Participant</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                {% if stat.is_checked_in %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Checked In
                                    </span><br>
                                    <small class="text-muted">{{ stat.checked_in_at|date:"M d, H:i" }}</small>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock"></i> Not Checked In
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% if role_filter == 'participant' or role_filter == 'all' %}
                        <td>
                            {% if stat.participant %}
                                <strong>{{ stat.total_spent|floatformat:2 }}â‚¬</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                <span class="badge bg-info">{{ stat.transaction_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                <span class="badge bg-success">{{ stat.room_access_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                <span class="badge bg-primary">{{ stat.scan_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            {% if stat.assignment.assigned_by %}
                                {{ stat.assignment.assigned_by.get_full_name|default:stat.assignment.assigned_by.username }}
                            {% else %}
                                <span class="text-muted">System</span>
                            {% endif %}
                        </td>
                        <td><small>{{ stat.assignment.assigned_at|date:"M d, Y H:i" }}</small></td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'dashboard:user_detail' stat.user.id %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-user-btn" data-user-id="{{ stat.user.id }}" data-user-name="{{ stat.user.get_full_name|default:stat.user.username }}" data-event-id="{{ event.id }}" title="Remove from Event">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-person-x" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3">No users assigned to this event yet.</p>
            <a href="{% url 'dashboard:user_create' %}?event={{ event.id }}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Add First User
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- Summary Cards -->
    {% if user_stats %}
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-primary">{{ role_counts.all }}</h4>
                <p class="text-muted mb-0">Total Users</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-success">{{ role_counts.participant }}</h4>
                <p class="text-muted mb-0">Participants</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-info">{{ role_counts.controlleur_des_badges }}</h4>
                <p class="text-muted mb-0">Controllers</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-warning">{{ role_counts.exposant }}</h4>
                <p class="text-muted mb-0">Exhibitors</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSearchInput = document.getElementById('userSearchInput');
    const roleButtons = document.querySelectorAll('.btn-group button[data-role]');
    const usersTable = document.getElementById('usersTable');
    let currentRole = 'all';
    
    // Search functionality
    if (userSearchInput && usersTable) {
        userSearchInput.addEventListener('input', function() {
            filterUsers();
        });
    }
    
    // Role filter functionality
    roleButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active button
            roleButtons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            
            // Update current role
            currentRole = this.getAttribute('data-role');
            filterUsers();
        });
    });
    
    function filterUsers() {
        const searchTerm = userSearchInput ? userSearchInput.value.toLowerCase() : '';
        const rows = usersTable ? usersTable.querySelectorAll('tbody tr') : [];
        
        rows.forEach(row => {
            const fullname = row.getAttribute('data-fullname') || '';
            const username = row.getAttribute('data-username') || '';
            const email = row.getAttribute('data-email') || '';
            const role = row.getAttribute('data-role') || '';
            
            const matchesSearch = !searchTerm || 
                fullname.includes(searchTerm) || 
                username.includes(searchTerm) || 
                email.includes(searchTerm);
            
            const matchesRole = currentRole === 'all' || role === currentRole;
            
            if (matchesSearch && matchesRole) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Delete user handler
    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.delete-user-btn')) {
            const button = e.target.closest('.delete-user-btn');
            const userId = button.getAttribute('data-user-id');
            const userName = button.getAttribute('data-user-name');
            const eventId = button.getAttribute('data-event-id');
            
            if (confirm(`Are you sure you want to remove "${userName}" from this event?\n\nThis will remove their assignment and access to this event.`)) {
                // Create form dynamically
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/dashboard/events/${eventId}/users/${userId}/delete/`;
                form.style.display = 'none';
                
                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // Add to body and submit
                document.body.appendChild(form);
                form.submit();
            }
        }
    });
});
</script>
{% endblock %}
