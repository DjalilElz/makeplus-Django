{% extends 'dashboard/base.html' %}

{% block page_title %}{{ event.name }} - Users{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-people"></i> Event Users</h2>
            <p class="text-muted mb-0">{{ event.name }}</p>
        </div>
        <div>
            <a href="{% url 'dashboard:event_detail' event.id %}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Event
            </a>
            <a href="{% url 'dashboard:user_create' %}?event={{ event.id }}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Add User
            </a>
        </div>
    </div>
    
    <!-- Role Filter Buttons -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <a href="?role=all" class="btn {% if role_filter == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-people"></i> All ({{ role_counts.all }})
            </a>
            <a href="?role=organisateur" class="btn {% if role_filter == 'organisateur' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-person-badge"></i> Organizers ({{ role_counts.organisateur }})
            </a>
            <a href="?role=gestionnaire_des_salles" class="btn {% if role_filter == 'gestionnaire_des_salles' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-door-open"></i> Room Managers ({{ role_counts.gestionnaire_des_salles }})
            </a>
            <a href="?role=controlleur_des_badges" class="btn {% if role_filter == 'controlleur_des_badges' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-qr-code-scan"></i> Controllers ({{ role_counts.controlleur_des_badges }})
            </a>
            <a href="?role=exposant" class="btn {% if role_filter == 'exposant' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-shop"></i> Exhibitors ({{ role_counts.exposant }})
            </a>
            <a href="?role=participant" class="btn {% if role_filter == 'participant' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-person"></i> Participants ({{ role_counts.participant }})
            </a>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="stat-card">
        {% if user_stats %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Badge ID</th>
                        <th>Role</th>
                        <th>Check-in Status</th>
                        {% if role_filter == 'participant' or role_filter == 'all' %}
                        <th>Spent</th>
                        <th>Transactions</th>
                        <th>Accesses</th>
                        <th>Scans</th>
                        {% endif %}
                        <th>Assigned By</th>
                        <th>Assigned Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in user_stats %}
                    <tr>
                        <td>
                            <strong>{{ stat.user.first_name }} {{ stat.user.last_name }}</strong><br>
                            <small class="text-muted">@{{ stat.user.username }}</small>
                        </td>
                        <td>{{ stat.user.email|default:"No email" }}</td>
                        <td>
                            {% if stat.user.profile.qr_code_data %}
                                <code class="small text-primary">{{ stat.user.profile.qr_code_data.badge_id }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.assignment.role == 'organisateur' %}
                                <span class="badge bg-primary">Organizer</span>
                            {% elif stat.assignment.role == 'gestionnaire_des_salles' %}
                                <span class="badge bg-info">Room Manager</span>
                            {% elif stat.assignment.role == 'controlleur_des_badges' %}
                                <span class="badge bg-warning text-dark">Controller</span>
                            {% elif stat.assignment.role == 'exposant' %}
                                <span class="badge bg-success">Exhibitor</span>
                            {% elif stat.assignment.role == 'participant' %}
                                <span class="badge bg-secondary">Participant</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                {% if stat.is_checked_in %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Checked In
                                    </span><br>
                                    <small class="text-muted">{{ stat.checked_in_at|date:"M d, H:i" }}</small>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock"></i> Not Checked In
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% if role_filter == 'participant' or role_filter == 'all' %}
                        <td>
                            {% if stat.participant %}
                                <strong>{{ stat.total_spent|floatformat:2 }}â‚¬</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                <span class="badge bg-info">{{ stat.transaction_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                <span class="badge bg-success">{{ stat.room_access_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.participant %}
                                <span class="badge bg-primary">{{ stat.scan_count }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            {% if stat.assignment.assigned_by %}
                                {{ stat.assignment.assigned_by.get_full_name|default:stat.assignment.assigned_by.username }}
                            {% else %}
                                <span class="text-muted">System</span>
                            {% endif %}
                        </td>
                        <td><small>{{ stat.assignment.assigned_at|date:"M d, Y H:i" }}</small></td>
                        <td>
                            <a href="{% url 'dashboard:user_detail' stat.user.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-person-x" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3">No users assigned to this event yet.</p>
            <a href="{% url 'dashboard:user_create' %}?event={{ event.id }}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Add First User
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- Summary Cards -->
    {% if user_stats %}
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-primary">{{ role_counts.all }}</h4>
                <p class="text-muted mb-0">Total Users</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-success">{{ role_counts.participant }}</h4>
                <p class="text-muted mb-0">Participants</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-info">{{ role_counts.controlleur_des_badges }}</h4>
                <p class="text-muted mb-0">Controllers</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <h4 class="text-warning">{{ role_counts.exposant }}</h4>
                <p class="text-muted mb-0">Exhibitors</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
